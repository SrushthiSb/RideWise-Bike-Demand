{% extends 'predictor/base.html' %}
{% load static %}

{% block content %}
<div class="hero" style="padding-top: 40px;">
    <h1>Stations <span>Near You</span></h1>
    <p class="subtitle">Showing bicycle hubs within 5km of your current position.</p>

    <div style="display: flex; gap: 20px; max-width: 1200px; margin: auto; text-align: left;">
        <div id="map" style="flex: 2; height: 550px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 8px solid white;"></div>

        <div id="details-panel" style="flex: 1;">
            <div id="status-card" style="background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);">
                <h2 id="st-name">Detecting Location...</h2>
                <hr style="margin: 15px 0; opacity: 0.1;">
                
                <div id="info-content" style="display: none;">
                    <div style="background: #e8fff4; padding: 15px; border-radius: 12px; margin-bottom: 10px;">
                        <span style="display:block; font-size: 0.8rem; color: #16a34a;">Available Bikes</span>
                        <b id="st-avail" style="font-size: 1.5rem;">-</b>
                    </div>
                    <div style="background: #f4f4f4; padding: 15px; border-radius: 12px; margin-bottom: 10px;">
                        <span style="display:block; font-size: 0.8rem; color: #666;">Total Capacity</span>
                        <b id="st-cap" style="font-size: 1.2rem;">-</b>
                    </div>
                    <div style="background: #fff5dc; padding: 15px; border-radius: 12px;">
                        <span style="display:block; font-size: 0.8rem; color: #b45309;">Utilization</span>
                        <b id="st-util" style="font-size: 1.2rem;">-%</b>
                    </div>
                    <p id="st-coords" style="margin-top: 15px; font-size: 0.75rem; color: #999;">Coordinates: -</p>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>



<script>
    // 1. Initialize Map (Default view before location is found)
    var map = L.map('map').setView([20, 0], 2); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // 2. Function to add "Nearby" Stations based on User Coords
    function loadNearbyStations(userLat, userLng) {
        // Here we simulate stations near your actual location
        const nearbyStations = [
            { name: "Local Hub A", lat: userLat + 0.005, lng: userLng + 0.003, avail: 12, cap: 20 },
            { name: "City Center Point", lat: userLat - 0.002, lng: userLng + 0.008, avail: 4, cap: 25 },
            { name: "Transit Station", lat: userLat + 0.007, lng: userLng - 0.004, avail: 18, cap: 30 }
        ];

        nearbyStations.forEach(st => {
            let marker = L.circleMarker([st.lat, st.lng], {
                radius: 12,
                fillColor: "#1bbf73",
                color: "white",
                weight: 3,
                fillOpacity: 0.9
            }).addTo(map);

            marker.on('click', function() {
                document.getElementById('info-content').style.display = "block";
                document.getElementById('st-name').innerText = st.name;
                document.getElementById('st-avail').innerText = st.avail;
                document.getElementById('st-cap').innerText = st.cap;
                document.getElementById('st-util').innerText = Math.round((st.avail/st.cap)*100) + "%";
                document.getElementById('st-coords').innerText = `Coordinates: ${st.lat.toFixed(4)}, ${st.lng.toFixed(4)}`;
            });
        });
    }

    // 3. Get Actual Current Location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const { latitude, longitude } = position.coords;
                
                // Center map on User
                map.setView([latitude, longitude], 15);

                // Add "You Are Here" Marker
                L.marker([latitude, longitude]).addTo(map)
                    .bindPopup("<b>You are here</b>").openPopup();

                document.getElementById('st-name').innerText = "Select a station near you";
                
                // Load stations around the user
                loadNearbyStations(latitude, longitude);
            },
            () => {
                document.getElementById('st-name').innerText = "Location access denied.";
            }
        );
    } else {
        document.getElementById('st-name').innerText = "Browser doesn't support geolocation.";
    }
</script>
{% endblock %}