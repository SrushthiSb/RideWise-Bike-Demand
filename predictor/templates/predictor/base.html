{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>RideWise</title>
    <link rel="stylesheet" href="{% static 'predictor/css/style.css' %}">
    
</head>
<body>

    {% if user.is_authenticated %}
    <header class="navbar">
        <div class="logo">ğŸš² RideWise</div>
        <nav>
            <a href="{% url 'home' %}">Home</a>
            <a href="{% url 'profile' %}" class="profile-icon">ğŸ‘¤</a>
        </nav>   
    </header>

    <div class="main-framework">
        <aside class="sidebar">
            <div class="sidebar-links">
                <a href="{% url 'dashboard' %}">ğŸ“Š Dashboard</a>
                <a href="{% url 'predict_selection' %}">ğŸ“ˆ Predict Demand</a>
                <a href="{% url 'station_map' %}">ğŸ—ºï¸ Station Map</a>
                <a href="{% url 'reserve' %}">ğŸ« Reserve Bike</a>    
                <a href="{% url 'about' %}">â„¹ï¸ About</a>
                <a href="{% url 'reviews' %}">ğŸ’¬ Reviews</a>
            </div>
        </aside>

        <main class="content-display">
            {% block content %}{% endblock %}
        </main>
    </div>
{% else %}
<div class="landing-page-container">
    {% block content_no_auth %}{% endblock %}
</div>
{% endif %}

<div id="chatbot-wrapper">
    <div id="chat-window" class="chat-hidden">
        <div class="chat-header">
            <span class="status-dot"></span>
            <span>RideWise AI</span>
            <button onclick="toggleChat()">âœ•</button>
        </div>

        <div id="chat-messages" class="chat-body">
            <div class="msg bot">
                Hello! I'm your RideWise assistant. How can I help?
            </div>
        </div>

        <div class="chat-footer">
            <input id="user-input" placeholder="Ask me anything..." onkeypress="handleKey(event)">
            <button onclick="sendChatMessage()">â¤</button>
        </div>
    </div>

    <div id="chat-trigger" onclick="toggleChat()">ğŸ¤–</div>
</div>


<script>
    let slideIndex = 0;

    window.onload = function() {
        startSliding();
    };

    function startSliding() {
        const wrapper = document.getElementById("main-slider");
        const slides = document.getElementsByClassName("mySlides");
        
        if (!wrapper || slides.length === 0) return;

        setInterval(() => {
            slideIndex++;
            
            if (slideIndex >= slides.length) {
                slideIndex = 0;
            }
            
            // Move the entire strip to the left
            // Slide 0: 0%, Slide 1: -25%, Slide 2: -50%, Slide 3: -75%
            const percentage = slideIndex * -25; 
            wrapper.style.transform = `translateX(${percentage}%)`;
            
        }, 3000); // 3 Seconds
    }
    ///chat bot
    function toggleChat() {
        document.getElementById("chat-window").classList.toggle("chat-hidden");
    }

    function handleKey(e) {
        if (e.key === "Enter") sendChatMessage();
    }

    // Function to make the browser speak
    function speakText(text) {
        window.speechSynthesis.cancel(); // Stop any current speech
        const speech = new SpeechSynthesisUtterance(text);
        speech.lang = 'en-US';
        speech.rate = 1;
        window.speechSynthesis.speak(speech);
    }

    async function sendChatMessage() {
        const input = document.getElementById("user-input");
        const chat = document.getElementById("chat-messages");
        const text = input.value.trim();
        if (!text) return;

        // Display User Message
        chat.innerHTML += `<div class="msg user">${text}</div>`;
        input.value = "";
        chat.scrollTop = chat.scrollHeight;

        try {
    const res = await fetch("/gemini-chat/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify({message: text})
    });

    const data = await res.json();
    
    if (data.reply) {
        chat.innerHTML += `<div class="msg bot">${data.reply}</div>`;
        speakText(data.reply);
    } else {
        chat.innerHTML += `<div class="msg bot">I'm sorry, I couldn't process that.</div>`;
    }
    chat.scrollTop = chat.scrollHeight;

} catch (error) {
    chat.innerHTML += `<div class="msg bot">System Error: Connection failed.</div>`;
}
    }       
</script>
</body>
</html>
