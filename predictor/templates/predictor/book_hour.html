{% extends 'predictor/base.html' %}
{% load static %}

{% block content %}
<div class="hero">
    <span class="badge">ðŸš² RideWise</span>
    <h1>Predict <span>Hourly Bike Demand</span></h1>
    <p class="subtitle">
        Enter weather and hourly details to estimate bike demand.
    </p>

    <div class="form-container">
        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        <form method="POST">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="date">Date</label>
                <input type="date" name="date" id="date" required>
            </div>

            <div class="form-group">
                <label for="hour">Hour (0-23)</label>
                <input type="number" name="hour" id="hour" min="0" max="23" required>
                
            </div>

            <div class="form-group">
                <label for="season">Season</label>
                <select name="season" id="season" required>
                    <option value="1">Spring</option>
                    <option value="2">Summer</option>
                    <option value="3">Fall</option>
                    <option value="4">Winter</option>
                </select>
            </div>

            <div class="form-group">
                <label for="weathersit">Weather</label>
                <select name="weathersit" id="weathersit" required>
                    <option value="1">Clear</option>
                    <option value="2">Mist</option>
                    <option value="3">Light Rain</option>
                </select>
            </div>

            <div class="form-group">
                <label for="temp">Temp (Â°C)</label>
                <input type="number" step="any" name="temp" id="temp" required>
            </div>

            <div class="form-group">
                <label for="hum">Humidity (%)</label>
                <input type="number" step="any" name="hum" id="hum" required>
            </div>

            <div class="form-group">
                <label for="windspeed">Windspeed</label>
                <input type="number" step="any" name="windspeed" id="windspeed" required>
            </div>
            <button type="button" id="fetch-weather-btn" class="btn" style="width:auto; margin-left:10px;">
                Fetch Weather
            </button><br>
            <label>Auto-fill from PDF Report</label>
            <input type="file" id="pdf-upload" accept=".pdf" class="form-control">
            <button type="button" id="extract-pdf-btn" class="btn" style="width:auto; margin-top:10px;">
                Extract Values
            </button>
            <button type="submit" class="btn">Predict Demand</button>
        </form>
    </div>

    {% if prediction is not None %}
    <div class="stats">
        <div class="stat-card">
            <h2>{{ prediction }}</h2>
            <p>Predicted Hourly Demand</p>
        </div>
    </div>
    {% endif %}
</div>
<script>
    document.getElementById('fetch-weather-btn').addEventListener('click', function() {
    const dateField = document.getElementById('date');
    if (!dateField.value) {
        alert("Please select a date first.");
        return;
    }

    const btn = this;
    btn.innerText = "Locating...";

    // Use the browser's Geolocation API
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            btn.innerText = "Fetching Weather...";
            try {
                // Send lat and lon to your backend
                const response = await fetch(`/fetch-weather/?date=${dateField.value}&lat=${lat}&lon=${lon}`);
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                document.getElementById('temp').value = data.temp;
                document.getElementById('hum').value = data.hum;
                document.getElementById('windspeed').value = data.windspeed;
                document.getElementById('weathersit').value = data.weathersit;
                document.getElementById('season').value = data.season;
            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                btn.innerText = "Fetch Weather";
            }
        }, (error) => {
            alert("Location access denied. Please enable location services.");
            btn.innerText = "Fetch Weather";
        });
    } else {
        alert("Geolocation is not supported by your browser.");
    }
});

document.getElementById('extract-pdf-btn').addEventListener('click', async function() {
    const fileInput = document.getElementById('pdf-upload');
    if (!fileInput || fileInput.files.length === 0) {
        alert("Please select a PDF file first.");
        return;
    }

    const btn = this;
    const formData = new FormData();
    formData.append('pdf_file', fileInput.files[0]);

    btn.innerText = "Extracting...";
    
    try {
        const response = await fetch('/extract-pdf-data/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        // Check if the server actually sent a valid response
        if (!response.ok) {
            throw new Error(`Server error: ${response.statusText}`);
        }

        const data = await response.json();

        if (data.error) throw new Error(data.error);

        if (data.hour !== undefined) {
    document.getElementById('hour').value = data.hour;
}
        // Auto-fill fields for DAILY prediction (No Hour)
        if (data.date) document.getElementById('date').value = data.date;
        if (data.temp) document.getElementById('temp').value = data.temp;
        if (data.hum) document.getElementById('hum').value = data.hum;
        if (data.windspeed) document.getElementById('windspeed').value = data.windspeed;
        if (data.weathersit) document.getElementById('weathersit').value = data.weathersit;
        if (data.season) document.getElementById('season').value = data.season;
        
        alert("Values extracted successfully!");
    } catch (error) {
        console.error(error);
        alert("Extraction Error: " + error.message);
    } finally {
        btn.innerText = "Extract Values";
    }
});
</script>
{% endblock %}